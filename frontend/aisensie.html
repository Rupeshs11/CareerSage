<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor - CareerSage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="bg-[#0d1117] text-gray-300">

    <!-- Header -->
    <div id="header-placeholder"></div>


    <!-- Main Content Area -->
    <main class="px-4 md:px-8 pb-8">
        <div class="max-w-3xl mx-auto text-center mt-6">
            <h1 class="text-3xl md:text-5xl font-extrabold text-white">What can I help you learn?</h1>
            <p class="mt-3 md:mt-4 text-base md:text-lg text-gray-400">Enter a topic below to generate a personalized
                roadmap for it</p>

            <div class="mt-6 md:mt-10 bg-[#161b22] p-4 md:p-8 rounded-xl border border-gray-800 text-left">
                <!-- Topic Input with Trending Dropdown -->
                <div class="mb-6">
                    <label for="ai-topic" class="block mb-2 font-semibold text-gray-300">What do you want to
                        learn?</label>
                    <div class="relative">
                        <input type="text" id="ai-topic" autocomplete="off"
                            class="w-full bg-[#0d1117] border border-gray-700 rounded-lg p-3 pr-10 focus:ring-2 focus:ring-blue-500 focus:outline-none text-white"
                            placeholder="Type or select a topic...">
                        <button type="button"
                            onclick="document.getElementById('topic-dropdown').classList.toggle('hidden')"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="topic-dropdown"
                            class="hidden absolute z-50 w-full mt-1 bg-[#161b22] border border-gray-700 rounded-lg max-h-60 overflow-y-auto shadow-xl">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <span class="text-gray-500 text-sm">Trending:</span>
                        <button type="button" onclick="selectTopic('Frontend Development')"
                            class="text-xs bg-blue-600/20 hover:bg-blue-600/30 text-blue-300 px-2.5 py-1 rounded-full border border-blue-500/30">Frontend
                            Development</button>
                        <button type="button" onclick="selectTopic('Backend Development')"
                            class="text-xs bg-green-600/20 hover:bg-green-600/30 text-green-300 px-2.5 py-1 rounded-full border border-green-500/30">Backend
                            Development</button>
                        <button type="button" onclick="selectTopic('DevOps Engineer')"
                            class="text-xs bg-purple-600/20 hover:bg-purple-600/30 text-purple-300 px-2.5 py-1 rounded-full border border-purple-500/30">DevOps</button>
                        <button type="button" onclick="selectTopic('Machine Learning')"
                            class="text-xs bg-yellow-600/20 hover:bg-yellow-600/30 text-yellow-300 px-2.5 py-1 rounded-full border border-yellow-500/30">Machine
                            Learning</button>
                        <button type="button" onclick="selectTopic('Cyber Security')"
                            class="text-xs bg-red-600/20 hover:bg-red-600/30 text-red-300 px-2.5 py-1 rounded-full border border-red-500/30">Cyber
                            Security</button>
                    </div>
                </div>







                <!-- Generate Button -->
                <button id="generate-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg flex items-center justify-center gap-2 mt-6 transition-transform transform hover:scale-[1.02]">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" />
                    </svg>
                    Generate My Roadmap
                </button>

                <!-- Loading State (Hidden initially) -->
                <div id="loading-state" class="hidden mt-6 text-center">
                    <div
                        class="inline-flex items-center gap-3 bg-blue-900/30 border border-blue-800 rounded-lg px-6 py-4">
                        <svg class="animate-spin w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        <span class="text-blue-300 font-medium">AI is generating your personalized roadmap...</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div id="footer-placeholder"></div>

    <script src="js/load-header-footer.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js?v=2" type="module"></script>
    <script>
        // All suggested topics for dropdown
        const SUGGESTED_TOPICS = [
            'Frontend Development', 'Backend Development', 'Full Stack Development',
            'React Developer', 'Angular Developer', 'Vue.js Developer',
            'Node.js Developer', 'Python Developer', 'Java Developer',
            'DevOps Engineer', 'Cloud Engineer (AWS)', 'Cloud Engineer (Azure)',
            'Machine Learning', 'Data Science', 'Deep Learning',
            'Cyber Security', 'Ethical Hacking', 'Network Security',
            'Mobile App Development', 'Flutter Developer', 'React Native Developer',
            'Android Developer', 'iOS Developer',
            'Game Development', 'Unity Developer', 'Unreal Engine',
            'Blockchain Developer', 'Web3 Developer',
            'Linux Administration', 'System Administration',
            'Database Administration', 'SQL & NoSQL',
            'UI/UX Design', 'Product Design',
            'Embedded Systems', 'IoT Developer',
            'Kubernetes & Docker', 'Terraform & Infrastructure as Code',
            'Software Testing & QA', 'Automation Testing'
        ];

        // Populate and filter dropdown
        function renderTopicDropdown(filter = '') {
            const dropdown = document.getElementById('topic-dropdown');
            const filtered = filter
                ? SUGGESTED_TOPICS.filter(t => t.toLowerCase().includes(filter.toLowerCase()))
                : SUGGESTED_TOPICS;

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="p-3 text-gray-500 text-sm">No matching topics. You can type your own!</div>';
            } else {
                dropdown.innerHTML = filtered.map(t => `
                    <div class="px-4 py-2.5 hover:bg-gray-700 cursor-pointer text-gray-300 text-sm transition"
                         onclick="selectTopic('${t}')">${t}</div>
                `).join('');
            }
        }

        // Select a topic from dropdown or chip
        function selectTopic(topic) {
            document.getElementById('ai-topic').value = topic;
            document.getElementById('topic-dropdown').classList.add('hidden');
        }

        // Show filtered dropdown as user types
        document.getElementById('ai-topic')?.addEventListener('input', function () {
            const dropdown = document.getElementById('topic-dropdown');
            renderTopicDropdown(this.value);
            dropdown.classList.remove('hidden');
        });

        // Show full dropdown on focus
        document.getElementById('ai-topic')?.addEventListener('focus', function () {
            renderTopicDropdown(this.value);
            document.getElementById('topic-dropdown').classList.remove('hidden');
        });

        // Close dropdown on outside click
        document.addEventListener('click', function (e) {
            const dropdown = document.getElementById('topic-dropdown');
            const input = document.getElementById('ai-topic');
            if (!dropdown.contains(e.target) && e.target !== input) {
                dropdown.classList.add('hidden');
            }
        });

        // Validate topic input - reject gibberish
        function isValidTopic(text) {
            if (text.length < 2) return false;
            if (text.length > 100) return false;

            // Must contain at least one vowel
            const vowelRatio = (text.match(/[aeiouAEIOU]/g) || []).length / text.replace(/\s/g, '').length;
            if (vowelRatio < 0.1) return false;

            // No more than 5 consecutive consonants
            if (/[^aeiou\s]{6,}/i.test(text)) return false;

            // Must have at least one word with 2+ characters
            const words = text.split(/\s+/);
            if (!words.some(w => w.length >= 2)) return false;

            // No excessive special characters
            const specialCount = (text.match(/[^a-zA-Z0-9\s\-\/&().+#]/g) || []).length;
            if (specialCount > 3) return false;

            return true;
        }

        // Skills management
        let currentSkills = [];

        function addSkill() {
            const input = document.getElementById('skill-input');
            const skill = input.value.trim();
            if (skill && !currentSkills.includes(skill)) {
                currentSkills.push(skill);
                renderSkills();
                input.value = '';
            }
        }

        function quickAddSkill(skill) {
            if (!currentSkills.includes(skill)) {
                currentSkills.push(skill);
                renderSkills();
            }
        }

        function removeSkill(skill) {
            currentSkills = currentSkills.filter(s => s !== skill);
            renderSkills();
        }

        function renderSkills() {
            const container = document.getElementById('skills-container');
            container.innerHTML = currentSkills.map(skill => `
                <span class="bg-blue-600/20 border border-blue-500 text-blue-300 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                    ${skill}
                    <button onclick="removeSkill('${skill}')" class="hover:text-red-400">&times;</button>
                </span>
            `).join('');
        }

        // Sidebar dropdown toggle
        function toggleSidebarDropdown(menuId) {
            const menu = document.getElementById(menuId);
            menu.classList.toggle('hidden');
        }

        // Questions section toggle
        document.getElementById('better-roadmap-checkbox')?.addEventListener('change', function () {
            const section = document.getElementById('questions-section');
            if (this.checked) {
                section.classList.add('open');
            } else {
                section.classList.remove('open');
            }
        });

        // Enter key to add skill
        document.getElementById('skill-input')?.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSkill();
            }
        });

        // Generate roadmap button handler
        document.getElementById('generate-btn')?.addEventListener('click', async function () {
            const topic = document.getElementById('ai-topic').value.trim();

            // Empty check
            if (!topic) {
                alert('Please enter what you want to learn!');
                return;
            }

            // Gibberish validation
            if (!isValidTopic(topic)) {
                alert('That doesn\'t look like a valid topic. Please enter something like "Frontend Development" or "Machine Learning".');
                return;
            }

            // Check authentication
            if (!API.Auth.isAuthenticated()) {
                alert('Please login to generate a personalized roadmap!');
                window.location.href = './login.html';
                return;
            }

            const generateBtn = this;
            const loadingState = document.getElementById('loading-state');

            // Show loading
            generateBtn.classList.add('hidden');
            loadingState.classList.remove('hidden');

            // Clear previous roadmap data
            localStorage.removeItem('generated_roadmap');

            try {
                const response = await API.AI.generateRoadmap(
                    topic,
                    currentSkills,
                    'all', // Default to all levels
                    'learn' // Default career goal
                );

                console.log('Roadmap generated:', response);

                // Store the generated roadmap for viewing
                if (response.roadmap) {
                    localStorage.setItem('generated_roadmap', JSON.stringify(response.roadmap));
                    // Redirect to view the roadmap with cache-busting timestamp
                    const timestamp = Date.now();
                    window.location.href = `./roadmap-visual.html?id=${response.roadmap.id}&ai=true&t=${timestamp}`;
                }

            } catch (error) {
                console.error('Generation failed:', error);

                // If token is invalid/expired, redirect to login
                if (error.status === 401 || error.message?.includes('token') || error.message?.includes('Token')) {
                    alert('Your session has expired. Please login again.');
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('user');
                    window.location.href = './login.html';
                    return;
                }

                alert(error.message || 'Failed to generate roadmap. Please try again.');

                // Hide loading and show button again
                generateBtn.classList.remove('hidden');
                loadingState.classList.add('hidden');
            }
        });
    </script>
</body>

</html>