<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Battle - CareerSage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 8px rgba(99, 102, 241, 0.4)
            }

            50% {
                box-shadow: 0 0 24px rgba(99, 102, 241, 0.8)
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0)
            }

            25% {
                transform: translateX(-4px)
            }

            75% {
                transform: translateX(4px)
            }
        }

        @keyframes pop-in {
            from {
                transform: scale(0.8);
                opacity: 0
            }

            to {
                transform: scale(1);
                opacity: 1
            }
        }

        @keyframes count-up {
            from {
                opacity: 0;
                transform: translateY(10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .shake {
            animation: shake 0.3s ease;
        }

        .pop-in {
            animation: pop-in 0.4s ease;
        }

        .count-up {
            animation: count-up 0.5s ease;
        }

        .timer-danger {
            color: #ef4444 !important;
            animation: shake 0.5s ease infinite;
        }

        .correct-flash {
            background: rgba(34, 197, 94, 0.2) !important;
            border-color: #22c55e !important;
        }

        .wrong-flash {
            background: rgba(239, 68, 68, 0.2) !important;
            border-color: #ef4444 !important;
        }
    </style>
</head>

<body class="bg-[#0d1117] text-gray-300">
    <div class="flex flex-col min-h-screen pt-16 pb-16">
        <div id="header-placeholder"></div>

        <main class="flex-1 overflow-y-auto">
            <div class="container mx-auto px-6 py-8 max-w-5xl">

                <!-- ==================== LOBBY VIEW ==================== -->
                <div id="lobby-view">
                    <!-- Hero -->
                    <div class="text-center mb-10">
                        <h1 class="text-4xl font-extrabold text-white mb-2">Skill Battle</h1>
                        <p class="text-gray-400 text-lg">Challenge others in rapid-fire tech quizzes. Climb the
                            leaderboard. Earn badges.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left: Start Battle -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Topic Picker -->
                            <div class="bg-[#161b22] border border-gray-800 rounded-xl p-6">
                                <h2 class="text-xl font-bold text-white mb-4">Start a Battle</h2>
                                <div class="mb-4">
                                    <label class="text-sm text-gray-400 mb-2 block">Choose Topic</label>
                                    <input id="battle-topic" type="text" placeholder="e.g. JavaScript, Docker, React..."
                                        class="w-full bg-[#0d1117] border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-indigo-500 focus:outline-none transition">
                                </div>
                                <div class="flex flex-wrap gap-2 mb-5">
                                    <button onclick="document.getElementById('battle-topic').value=this.textContent"
                                        class="px-3 py-1.5 bg-indigo-900/40 border border-indigo-700 text-indigo-300 rounded-full text-sm hover:bg-indigo-800/60 transition">JavaScript</button>
                                    <button onclick="document.getElementById('battle-topic').value=this.textContent"
                                        class="px-3 py-1.5 bg-purple-900/40 border border-purple-700 text-purple-300 rounded-full text-sm hover:bg-purple-800/60 transition">Python</button>
                                    <button onclick="document.getElementById('battle-topic').value=this.textContent"
                                        class="px-3 py-1.5 bg-green-900/40 border border-green-700 text-green-300 rounded-full text-sm hover:bg-green-800/60 transition">DevOps</button>
                                    <button onclick="document.getElementById('battle-topic').value=this.textContent"
                                        class="px-3 py-1.5 bg-blue-900/40 border border-blue-700 text-blue-300 rounded-full text-sm hover:bg-blue-800/60 transition">React</button>
                                    <button onclick="document.getElementById('battle-topic').value=this.textContent"
                                        class="px-3 py-1.5 bg-yellow-900/40 border border-yellow-700 text-yellow-300 rounded-full text-sm hover:bg-yellow-800/60 transition">Docker</button>
                                    <button onclick="document.getElementById('battle-topic').value=this.textContent"
                                        class="px-3 py-1.5 bg-red-900/40 border border-red-700 text-red-300 rounded-full text-sm hover:bg-red-800/60 transition">SQL</button>
                                </div>
                                <div class="flex gap-3">
                                    <button id="btn-create-battle" onclick="createBattle()"
                                        class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-3 rounded-lg transition transform hover:scale-[1.02]">
                                        Create Battle (Multiplayer)
                                    </button>
                                    <button id="btn-solo-quick" onclick="createBattle(true)"
                                        class="px-6 bg-[#0d1117] border border-gray-700 hover:border-indigo-500 text-white font-semibold py-3 rounded-lg transition">
                                        Solo
                                    </button>
                                </div>
                            </div>

                            <!-- Join by Battle ID -->
                            <div class="bg-[#161b22] border border-gray-800 rounded-xl p-6">
                                <h2 class="text-lg font-bold text-white mb-3">Join by Battle ID</h2>
                                <div class="flex gap-3">
                                    <input type="text" id="join-battle-id" placeholder="Paste battle ID here..."
                                        class="flex-1 bg-[#0d1117] border border-gray-700 rounded-lg px-4 py-2.5 text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 transition text-sm">
                                    <button onclick="joinById()"
                                        class="px-5 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2.5 rounded-lg transition text-sm">
                                        Join
                                    </button>
                                </div>
                            </div>
                            <div class="bg-[#161b22] border border-gray-800 rounded-xl p-6">
                                <h2 class="text-lg font-bold text-white mb-4">Open Battles</h2>
                                <div id="active-battles-list" class="space-y-3 max-h-[250px] overflow-y-auto">
                                    <p class="text-gray-500 text-sm text-center py-4" id="no-battles-msg">No open
                                        battles right now. Create one!</p>
                                </div>
                            </div>

                            <!-- Battle History -->
                            <div class="bg-[#161b22] border border-gray-800 rounded-xl p-6">
                                <h2 class="text-lg font-bold text-white mb-4">Recent Battles</h2>
                                <div id="battle-history" class="space-y-2 max-h-[300px] overflow-y-auto">
                                    <p class="text-gray-500 text-sm text-center py-4">No battles yet</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Stats + Leaderboard + Friends -->
                        <div class="space-y-6">
                            <!-- My Stats -->
                            <div
                                class="bg-gradient-to-br from-indigo-900/50 to-purple-900/50 border border-indigo-800/60 rounded-xl p-6">
                                <h2 class="text-lg font-bold text-white mb-3">Your Stats</h2>
                                <div class="text-center mb-4">
                                    <p class="text-4xl font-extrabold text-white count-up" id="my-rating">1000</p>
                                    <p class="text-sm text-indigo-300">Rating</p>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-center mb-4">
                                    <div>
                                        <p class="text-lg font-bold text-green-400" id="my-wins">0</p>
                                        <p class="text-xs text-gray-400">Wins</p>
                                    </div>
                                    <div>
                                        <p class="text-lg font-bold text-red-400" id="my-losses">0</p>
                                        <p class="text-xs text-gray-400">Losses</p>
                                    </div>
                                    <div>
                                        <p class="text-lg font-bold text-yellow-400" id="my-draws">0</p>
                                        <p class="text-xs text-gray-400">Draws</p>
                                    </div>
                                </div>
                                <div id="my-badges" class="flex flex-wrap gap-2">
                                    <span class="text-gray-500 text-sm">No badges yet</span>
                                </div>
                            </div>

                            <!-- Leaderboard -->
                            <div class="bg-[#161b22] border border-gray-800 rounded-xl p-6">
                                <h2 class="text-lg font-bold text-white mb-4">Leaderboard</h2>
                                <div id="leaderboard" class="space-y-2 max-h-[350px] overflow-y-auto">
                                    <p class="text-gray-500 text-sm text-center">Loading...</p>
                                </div>
                            </div>

                            <!-- Friends -->
                            <div class="bg-[#161b22] border border-gray-800 rounded-xl p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg font-bold text-white">Friends</h2>
                                </div>
                                <div class="mb-4">
                                    <div class="flex gap-2">
                                        <input type="text" id="add-friend-email" placeholder="Enter email to add..."
                                            class="flex-1 bg-[#0d1117] border border-gray-700 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 transition text-xs">
                                        <button onclick="addFriendFromInput()"
                                            class="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-xs font-semibold transition">Add</button>
                                    </div>
                                </div>
                                <div id="friends-list" class="space-y-2 max-h-[250px] overflow-y-auto">
                                    <p class="text-gray-500 text-xs text-center py-3">No friends yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== WAITING VIEW ==================== -->
                <div id="waiting-view" class="hidden">
                    <div class="text-center py-20">
                        <div
                            class="w-20 h-20 rounded-full bg-indigo-600/20 border-2 border-indigo-500 flex items-center justify-center mx-auto mb-6 pulse-glow">
                            <svg class="w-10 h-10 text-indigo-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">Waiting for opponent...</h2>
                        <p class="text-gray-400 mb-2">Topic: <span id="waiting-topic"
                                class="text-indigo-400 font-semibold"></span></p>
                        <p class="text-gray-500 text-sm mb-6">Share the battle ID with a friend, or wait for someone to
                            join.</p>
                        <div class="flex items-center justify-center gap-3 mb-6">
                            <code id="waiting-battle-id"
                                class="bg-[#161b22] border border-gray-700 rounded-lg px-4 py-2 text-indigo-400 text-sm"></code>
                            <button onclick="copyBattleId()"
                                class="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm transition">Copy</button>
                        </div>
                        <div class="flex justify-center gap-3">
                            <button onclick="startSolo()"
                                class="px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white font-semibold rounded-lg transition">
                                Play Solo Instead
                            </button>
                            <button onclick="cancelBattle()"
                                class="px-6 py-3 bg-gray-800 hover:bg-gray-700 text-gray-300 font-semibold rounded-lg transition">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ==================== BATTLE VIEW ==================== -->
                <div id="battle-view" class="hidden">
                    <!-- Battle Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="text-center">
                            <p class="text-white font-bold text-lg" id="player-name">You</p>
                            <p class="text-3xl font-extrabold text-indigo-400" id="player-score">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-400 text-sm" id="battle-topic-display">Topic</p>
                            <p class="text-5xl font-extrabold text-white" id="battle-timer">15</p>
                            <p class="text-gray-500 text-xs mt-1">Question <span id="question-counter">1</span>/10</p>
                        </div>
                        <div class="text-center">
                            <p class="text-white font-bold text-lg" id="opponent-name">Opponent</p>
                            <p class="text-3xl font-extrabold text-red-400" id="opponent-score">0</p>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-800 rounded-full h-2 mb-6">
                        <div id="battle-progress"
                            class="h-2 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300"
                            style="width: 0%"></div>
                    </div>

                    <!-- Question Card -->
                    <div class="bg-[#161b22] border border-gray-800 rounded-xl p-8 mb-4 pop-in" id="question-card">
                        <h3 class="text-xl font-bold text-white mb-6" id="question-text">Loading question...</h3>
                        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Options rendered by JS -->
                        </div>
                    </div>
                </div>

                <!-- ==================== RESULTS VIEW ==================== -->
                <div id="results-view" class="hidden">
                    <div class="text-center py-8">
                        <div class="text-4xl font-extrabold mb-4" id="result-emoji"></div>
                        <h2 class="text-3xl font-extrabold text-white mb-2" id="result-title">Victory!</h2>
                        <p class="text-gray-400 mb-8" id="result-subtitle">Great battle!</p>

                        <!-- Score Comparison -->
                        <div class="flex justify-center items-center gap-8 mb-8">
                            <div class="bg-[#161b22] border border-indigo-700 rounded-xl p-6 w-48 text-center">
                                <p class="text-sm text-gray-400 mb-1" id="result-player-name">You</p>
                                <p class="text-4xl font-extrabold text-indigo-400" id="result-player-score">0</p>
                                <p class="text-gray-500 text-sm">/10</p>
                            </div>
                            <span class="text-3xl text-gray-600 font-bold">VS</span>
                            <div class="bg-[#161b22] border border-red-700/50 rounded-xl p-6 w-48 text-center">
                                <p class="text-sm text-gray-400 mb-1" id="result-opponent-name">Opponent</p>
                                <p class="text-4xl font-extrabold text-red-400" id="result-opponent-score">0</p>
                                <p class="text-gray-500 text-sm">/10</p>
                            </div>
                        </div>

                        <!-- Rating Change -->
                        <div class="bg-[#161b22] border border-gray-800 rounded-xl p-4 inline-block mb-6">
                            <p class="text-gray-400 text-sm">Rating</p>
                            <p class="text-2xl font-bold" id="rating-change">+0</p>
                        </div>

                        <!-- New Badges -->
                        <div id="new-badges-section" class="hidden mb-6">
                            <p class="text-lg font-bold text-yellow-400 mb-2">New Badge Earned!</p>
                            <div id="new-badges-list" class="flex justify-center gap-3"></div>
                        </div>

                        <div class="flex flex-wrap justify-center gap-3 mt-6" id="result-actions">
                            <button onclick="playAgain()"
                                class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold rounded-lg transition">
                                Play Again
                            </button>
                            <button id="btn-add-friend-result" onclick="addOpponentAsFriend()"
                                class="hidden px-6 py-3 bg-green-700 hover:bg-green-600 text-white font-semibold rounded-lg transition">
                                Add Friend
                            </button>
                            <button onclick="showView('lobby-view'); loadLobbyData()"
                                class="px-8 py-3 bg-gray-800 hover:bg-gray-700 text-white font-semibold rounded-lg transition">
                                Back to Lobby
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <div id="footer-placeholder"></div>
    </div>

    <script src="js/load-header-footer.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js?v=2" type="module"></script>
    <script>
        // ============ State ============
        let socket = null;
        let currentBattleId = null;
        let currentQuestions = [];
        let currentQuestionIdx = 0;
        let myScore = 0;
        let opponentScore = 0;
        let timerInterval = null;
        let timeLeft = 15;
        let currentUserId = null;
        let currentUserName = 'You';
        let myRole = 'challenger';
        let answeredCurrentQ = false;
        let lastOpponentId = null;



        // ============ Init ============
        document.addEventListener('DOMContentLoaded', async () => {
            const user = API.Auth.getCurrentUser();
            if (!user) { window.location.href = './login.html'; return; }
            currentUserId = user.id;
            currentUserName = user.name?.split(' ')[0] || 'You';

            // Connect Socket.IO with longer timeout for AI question generation
            socket = io(window.location.origin, {
                pingTimeout: 60000,
                pingInterval: 25000,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            socket.on('connect', () => {
                console.log('Socket connected');
                socket.emit('register_user', { user_id: currentUserId });
            });
            socket.on('disconnect', () => {
                console.log('Socket disconnected, will auto-reconnect');
            });

            // Socket event handlers
            socket.on('battle_created', onBattleCreated);
            socket.on('battle_generating', (d) => {
                // Show generating status while AI creates questions
                document.getElementById('btn-create-battle').textContent = (d.message || 'Generating...');
            });
            socket.on('battle_start', onBattleStart);
            socket.on('opponent_joined', onOpponentJoined);
            socket.on('answer_result', onAnswerResult);
            socket.on('opponent_progress', onOpponentProgress);
            socket.on('battle_result', onBattleResult);
            socket.on('opponent_disconnected', onOpponentDisconnected);
            socket.on('error', (d) => { console.error('Socket error:', d); alert(d.message || 'Error'); });

            // Real-time: new battle appears for all users without refresh
            socket.on('new_battle_available', (b) => {
                // Skip if it's our own battle or we're not on the lobby view
                if (b.challenger?.id === currentUserId) return;
                const listEl = document.getElementById('active-battles-list');
                const noMsg = document.getElementById('no-battles-msg');
                if (noMsg) noMsg.style.display = 'none';
                const card = document.createElement('div');
                card.className = 'flex items-center gap-3 p-3 rounded-lg bg-[#0d1117] border border-gray-700 hover:border-indigo-500 transition cursor-pointer';
                card.setAttribute('onclick', "joinBattle('" + b.id + "')");
                card.innerHTML = '<div class="w-10 h-10 bg-indigo-600/20 rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>' +
                    '<div class="flex-1"><p class="text-white font-semibold text-sm">' + b.topic + '</p>' +
                    '<p class="text-gray-500 text-xs">by ' + (b.challenger?.name || 'Unknown') + '</p></div>' +
                    '<span class="px-3 py-1 bg-green-900/40 border border-green-700 text-green-400 rounded-full text-xs font-semibold">Join</span>';
                listEl.insertBefore(card, listEl.firstChild);
            });

            loadLobbyData();

            // Listen for real-time notifications (e.g., battle invites)
            socket.on('notification', (n) => {
                if (typeof loadNotifications === 'function') loadNotifications();
            });

            // Handle ?join=BATTLE_ID from notification links
            const params = new URLSearchParams(window.location.search);
            const joinId = params.get('join');
            if (joinId) {
                // Clean the URL
                window.history.replaceState({}, '', window.location.pathname);
                // Auto-join after a short delay for socket to connect
                setTimeout(() => joinBattle(joinId), 1500);
            }

            // Auto-refresh: friends + lobby every 15s when on lobby view
            setInterval(() => {
                const lobbyVisible = !document.getElementById('lobby-view').classList.contains('hidden');
                if (lobbyVisible) {
                    loadFriendsList();
                    loadLobbyData();
                }
            }, 15000);

            // Refresh on reconnect
            socket.on('reconnect', () => {
                socket.emit('register_user', { user_id: currentUserId });
                loadFriendsList();
            });

            // Refresh friends when someone accepts our request
            socket.on('friend_list_updated', () => loadFriendsList());
        });

        // ============ View Management ============
        function showView(viewId) {
            ['lobby-view', 'waiting-view', 'battle-view', 'results-view'].forEach(v => {
                document.getElementById(v).classList.toggle('hidden', v !== viewId);
            });
        }

        // ============ Lobby Data ============
        async function loadLobbyData() {
            try {
                // Stats
                const statsRes = await API.Battle.getStats();
                const s = statsRes.stats;
                document.getElementById('my-rating').textContent = s.rating;
                document.getElementById('my-wins').textContent = s.wins;
                document.getElementById('my-losses').textContent = s.losses;
                document.getElementById('my-draws').textContent = s.draws;

                const badgesEl = document.getElementById('my-badges');
                if (s.badges && s.badges.length > 0) {
                    badgesEl.innerHTML = s.badges.map(b =>
                        `<span class="px-2 py-1 bg-yellow-900/40 border border-yellow-700 text-yellow-300 rounded-full text-xs font-semibold">${b}</span>`
                    ).join('');
                }
            } catch (e) { console.warn('Stats load failed:', e); }

            try {
                // Leaderboard
                const lbRes = await API.Battle.getLeaderboard();
                const lb = lbRes.leaderboard || [];
                const lbEl = document.getElementById('leaderboard');
                if (lb.length > 0) {
                    const rankColors = ['text-yellow-400', 'text-gray-300', 'text-amber-600'];
                    lbEl.innerHTML = lb.map((u, i) => `
                        <div class="flex items-center gap-3 p-2.5 rounded-lg ${u.user_id === currentUserId ? 'bg-indigo-900/30 border border-indigo-700' : 'hover:bg-gray-800/40'} transition">
                            <span class="w-6 text-center font-bold ${rankColors[i] || 'text-gray-500'}">${i + 1}</span>
                            <div class="flex-1 min-w-0">
                                <p class="text-white text-sm font-medium truncate">${u.name} ${u.user_id === currentUserId ? '(You)' : ''}</p>
                                <p class="text-gray-500 text-xs">${u.wins}W / ${u.losses}L${u.badges?.length ? ' · ' + u.badges.map(b => b).join(', ') : ''}</p>
                            </div>
                            <span class="text-indigo-400 font-bold text-sm">${u.rating}</span>
                        </div>
                    `).join('');
                } else {
                    lbEl.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No players yet. Be the first!</p>';
                }
            } catch (e) { console.warn('Leaderboard load failed:', e); }

            try {
                // Active battles
                const activeRes = await API.Battle.getActiveBattles();
                const battles = activeRes.battles || [];
                const listEl = document.getElementById('active-battles-list');
                const noMsg = document.getElementById('no-battles-msg');
                if (battles.length > 0) {
                    noMsg.style.display = 'none';
                    listEl.innerHTML = battles.map(b => `
                        <div class="flex items-center gap-3 p-3 rounded-lg bg-[#0d1117] border border-gray-700 hover:border-indigo-500 transition cursor-pointer" onclick="joinBattle('${b.id}')">
                            <div class="w-10 h-10 bg-indigo-600/20 rounded-lg flex items-center justify-center"><svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>
                            <div class="flex-1">
                                <p class="text-white font-semibold text-sm">${b.topic}</p>
                                <p class="text-gray-500 text-xs">by ${b.challenger.name} · Rating: ${b.challenger.rating}</p>
                            </div>
                            <span class="px-3 py-1 bg-green-900/40 border border-green-700 text-green-400 rounded-full text-xs font-semibold">Join</span>
                        </div>
                    `).join('');
                } else {
                    noMsg.style.display = 'block';
                    listEl.innerHTML = '';
                    listEl.appendChild(noMsg);
                }
            } catch (e) { console.warn('Active battles load failed:', e); }

            try {
                // History
                const histRes = await API.Battle.getHistory();
                const hist = histRes.battles || [];
                const histEl = document.getElementById('battle-history');
                if (hist.length > 0) {
                    histEl.innerHTML = hist.map(b => {
                        const isChallenger = b.challenger?.id === currentUserId;
                        const myS = isChallenger ? b.challenger_score : b.opponent_score;
                        const opS = isChallenger ? b.opponent_score : b.challenger_score;
                        const won = b.winner_id === currentUserId;
                        const draw = b.is_draw;
                        const color = draw ? 'text-yellow-400' : (won ? 'text-green-400' : 'text-red-400');
                        return `
                            <div class="flex items-center gap-3 p-2.5 rounded-lg hover:bg-gray-800/30 transition">
                                <div class="flex-1 min-w-0">
                                    <p class="text-white text-sm font-medium truncate">${b.topic}</p>
                                    <p class="text-gray-500 text-xs">vs ${isChallenger ? b.opponent?.name : b.challenger?.name}</p>
                                </div>
                                <div class="text-right">
                                    <p class="${color} font-bold text-sm">${myS}–${opS}</p>
                                </div>
                            </div>`;
                    }).join('');
                }
            } catch (e) { console.warn('History load failed:', e); }

            // Load friends
            loadFriendsList();
        }

        // ============ Friends ============
        async function loadFriendsList() {
            try {
                const res = await API.Friends.getFriends();
                const friends = res.friends || [];
                const listEl = document.getElementById('friends-list');
                if (!listEl) return;

                if (friends.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-xs text-center py-3">No friends yet</p>';
                    return;
                }

                listEl.innerHTML = friends.map(f => {
                    const dot = f.online
                        ? '<span class="w-2 h-2 bg-green-400 rounded-full flex-shrink-0" title="Online"></span>'
                        : '<span class="w-2 h-2 bg-gray-600 rounded-full flex-shrink-0" title="Offline"></span>';
                    const status = f.online ? 'text-green-400' : 'text-gray-500';
                    return `
                        <div class="flex items-center gap-3 p-2.5 rounded-lg hover:bg-gray-800/30 transition">
                            ${dot}
                            <div class="flex-1 min-w-0">
                                <p class="text-white text-sm font-medium truncate">${f.name}</p>
                                <p class="${status} text-[10px]">${f.online ? 'Online' : 'Offline'}</p>
                            </div>
                            <div class="flex gap-1.5">
                                <button onclick="challengeFriend('${f.id}', '${f.name}')" class="px-2 py-1 bg-indigo-600/80 hover:bg-indigo-500 text-white rounded text-[10px] font-semibold transition" title="Challenge">Challenge</button>
                                <button onclick="inviteFriend('${f.id}', '${f.name}')" class="px-2 py-1 bg-purple-600/80 hover:bg-purple-500 text-white rounded text-[10px] font-semibold transition" title="Invite to current battle">Invite</button>
                            </div>
                        </div>`;
                }).join('');
            } catch (e) { console.warn('Friends load failed:', e); }
        }

        async function addFriendFromInput() {
            const input = document.getElementById('add-friend-email');
            const val = input.value.trim();
            if (!val) { alert('Enter an email address'); return; }
            try {
                await API.Friends.sendFriendRequest(val);
                input.value = '';
                alert('Friend request sent!');
            } catch (e) { alert('Failed: ' + (e.message || e)); }
        }

        function challengeFriend(friendId, friendName) {
            const topic = document.getElementById('battle-topic').value.trim();
            if (!topic) { alert('Enter a topic first, then challenge your friend!'); return; }
            // Create battle then invite
            createBattle(false);
            // After battle is created, send invite (listen once for battle_created)
            socket.once('battle_created', function (data) {
                socket.emit('battle_invite', {
                    from_user_id: currentUserId,
                    to_user_id: friendId,
                    battle_id: data.battle_id,
                    topic: topic
                });
                alert('Battle created and invite sent to ' + friendName + '!');
            });
        }

        function inviteFriend(friendId, friendName) {
            if (!currentBattleId) { alert('Create or join a battle first!'); return; }
            socket.emit('battle_invite', {
                from_user_id: currentUserId,
                to_user_id: friendId,
                battle_id: currentBattleId,
                topic: document.getElementById('waiting-topic')?.textContent || ''
            });
            alert('Invite sent to ' + friendName + '!');
        }

        async function addOpponentAsFriend() {
            if (!lastOpponentId) { alert('No opponent to add'); return; }
            try {
                await API.Friends.sendFriendRequest(lastOpponentId);
                document.getElementById('btn-add-friend-result').textContent = 'Request Sent';
                document.getElementById('btn-add-friend-result').disabled = true;
            } catch (e) { alert('Failed: ' + (e.message || e)); }
        }

        // ============ Battle Actions ============
        function createBattle(solo = false) {
            const topic = document.getElementById('battle-topic').value.trim();
            if (!topic) { alert('Please enter a topic!'); return; }

            document.getElementById('btn-create-battle').disabled = true;
            document.getElementById('btn-create-battle').textContent = 'Generating questions...';

            socket.emit('create_battle', { user_id: currentUserId, topic: topic });

            if (solo) {
                // Will trigger start_solo after battle_created
                window._startSoloAfterCreate = true;
            }
        }

        function joinBattle(battleId) {
            socket.emit('join_battle', { user_id: currentUserId, battle_id: battleId });
        }

        function joinById() {
            const id = document.getElementById('join-battle-id').value.trim();
            if (!id) { alert('Please enter a battle ID'); return; }
            joinBattle(id);
        }

        function startSolo() {
            if (currentBattleId) {
                socket.emit('start_solo', { battle_id: currentBattleId, user_id: currentUserId });
            }
        }

        function cancelBattle() {
            currentBattleId = null;
            showView('lobby-view');
            document.getElementById('btn-create-battle').disabled = false;
            document.getElementById('btn-create-battle').textContent = 'Create Battle (Multiplayer)';
        }

        function copyBattleId() {
            const id = document.getElementById('waiting-battle-id').textContent;
            navigator.clipboard.writeText(id);
            alert('Battle ID copied!');
        }

        function playAgain() {
            myScore = 0;
            opponentScore = 0;
            currentQuestionIdx = 0;
            currentQuestions = [];
            showView('lobby-view');
            loadLobbyData();
        }

        // ============ Socket Event Handlers ============
        function onBattleCreated(data) {
            currentBattleId = data.battle_id;
            currentQuestions = data.questions;

            document.getElementById('btn-create-battle').disabled = false;
            document.getElementById('btn-create-battle').textContent = 'Create Battle (Multiplayer)';

            if (window._startSoloAfterCreate) {
                window._startSoloAfterCreate = false;
                startSolo();
                return;
            }

            // Show waiting view
            document.getElementById('waiting-topic').textContent = data.topic;
            document.getElementById('waiting-battle-id').textContent = data.battle_id;
            showView('waiting-view');
        }

        function onOpponentJoined(data) {
            // Handled by battle_start
        }

        function onBattleStart(data) {
            currentBattleId = data.battle_id;
            currentQuestions = data.questions;
            currentQuestionIdx = 0;
            myScore = 0;
            opponentScore = 0;
            myRole = data.role || 'challenger';
            answeredCurrentQ = false;

            document.getElementById('player-name').textContent = currentUserName;
            document.getElementById('opponent-name').textContent = data.opponent?.name || 'AI Opponent';
            document.getElementById('battle-topic-display').textContent = data.topic;
            document.getElementById('player-score').textContent = '0';
            document.getElementById('opponent-score').textContent = '0';

            showView('battle-view');
            showQuestion(0);
        }

        function onAnswerResult(data) {
            myScore = data.your_score;
            document.getElementById('player-score').textContent = myScore;

            // Flash effect
            const card = document.getElementById('question-card');
            card.classList.add(data.is_correct ? 'correct-flash' : 'wrong-flash');
            setTimeout(() => {
                card.classList.remove('correct-flash', 'wrong-flash');
            }, 500);

            // Highlight correct option
            const options = document.querySelectorAll('.battle-option');
            options.forEach((opt, i) => {
                if (i === data.correct_answer) opt.classList.add('border-green-500', 'bg-green-900/20');
            });

            // Next question after brief delay
            setTimeout(() => {
                currentQuestionIdx++;
                if (currentQuestionIdx < currentQuestions.length) {
                    showQuestion(currentQuestionIdx);
                }
                // else wait for battle_result from server
            }, 800);
        }

        function onOpponentProgress(data) {
            opponentScore = data.opponent_score;
            document.getElementById('opponent-score').textContent = opponentScore;
        }

        function onBattleResult(data) {
            clearInterval(timerInterval);
            const battle = data.battle;
            const isChallenger = battle.challenger?.id === currentUserId;
            const myFinalScore = isChallenger ? battle.challenger_score : battle.opponent_score;
            const opFinalScore = isChallenger ? battle.opponent_score : battle.challenger_score;
            const won = battle.winner_id === currentUserId;
            const draw = battle.is_draw;

            // Result display
            document.getElementById('result-emoji').textContent = draw ? 'DRAW' : (won ? 'VICTORY' : 'DEFEAT');
            document.getElementById('result-title').textContent = draw ? 'Draw!' : (won ? 'Victory!' : 'Defeat');
            document.getElementById('result-subtitle').textContent = draw ? 'Evenly matched!' : (won ? 'You crushed it!' : 'Better luck next time!');
            document.getElementById('result-player-name').textContent = currentUserName;
            document.getElementById('result-opponent-name').textContent = isChallenger ? (battle.opponent?.name || 'AI') : battle.challenger?.name;
            document.getElementById('result-player-score').textContent = myFinalScore;
            document.getElementById('result-opponent-score').textContent = opFinalScore;

            // Rating change
            const ratingEl = document.getElementById('rating-change');
            const myRating = isChallenger ? data.challenger_rating : data.opponent_rating;
            if (myRating) {
                const prev = parseInt(document.getElementById('my-rating').textContent);
                const diff = myRating - prev;
                ratingEl.textContent = (diff >= 0 ? '+' : '') + diff;
                ratingEl.className = 'text-2xl font-bold ' + (diff >= 0 ? 'text-green-400' : 'text-red-400');
            }

            // New badges
            const newBadges = isChallenger ? data.challenger_new_badges : data.opponent_new_badges;
            if (newBadges && newBadges.length > 0) {
                document.getElementById('new-badges-section').classList.remove('hidden');
                document.getElementById('new-badges-list').innerHTML = newBadges.map(b =>
                    `<span class="px-4 py-2 bg-yellow-900/40 border border-yellow-600 text-yellow-300 rounded-full text-sm font-bold pop-in">${b}</span>`
                ).join('');
            } else {
                document.getElementById('new-badges-section').classList.add('hidden');
            }

            // Track opponent for Add Friend button
            const opponentData = isChallenger ? battle.opponent : battle.challenger;
            lastOpponentId = opponentData?.id || null;
            const addBtn = document.getElementById('btn-add-friend-result');
            if (lastOpponentId && !battle.is_solo) {
                addBtn.classList.remove('hidden');
                addBtn.textContent = 'Add Friend';
                addBtn.disabled = false;
            } else {
                addBtn.classList.add('hidden');
            }

            showView('results-view');
        }

        function onOpponentDisconnected(data) {
            alert('Opponent disconnected! Battle will be scored with current progress.');
        }

        // ============ Battle UI ============
        function showQuestion(idx) {
            if (idx >= currentQuestions.length) return;

            answeredCurrentQ = false;
            const q = currentQuestions[idx];
            document.getElementById('question-text').textContent = q.question;
            document.getElementById('question-counter').textContent = idx + 1;
            document.getElementById('battle-progress').style.width = ((idx / currentQuestions.length) * 100) + '%';

            const optContainer = document.getElementById('options-container');
            optContainer.innerHTML = q.options.map((opt, i) => `
                <button class="battle-option p-4 rounded-lg bg-[#0d1117] border border-gray-700 text-left text-white font-medium hover:border-indigo-500 hover:bg-indigo-900/20 transition transform hover:scale-[1.01]"
                    onclick="submitAnswer(${q.id}, ${i})">
                    <span class="text-indigo-400 font-bold mr-2">${['A', 'B', 'C', 'D'][i]}.</span> ${opt}
                </button>
            `).join('');

            // Animate card
            const card = document.getElementById('question-card');
            card.classList.remove('pop-in');
            void card.offsetWidth;
            card.classList.add('pop-in');

            // Start timer
            startTimer();
        }

        function submitAnswer(questionId, answerIdx) {
            if (answeredCurrentQ) return;
            answeredCurrentQ = true;

            clearInterval(timerInterval);

            // Disable all options
            document.querySelectorAll('.battle-option').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            });

            // Highlight selected
            const options = document.querySelectorAll('.battle-option');
            if (options[answerIdx]) {
                options[answerIdx].style.opacity = '1';
                options[answerIdx].classList.add('border-indigo-500', 'bg-indigo-900/30');
            }

            socket.emit('submit_answer', {
                battle_id: currentBattleId,
                user_id: currentUserId,
                question_id: questionId,
                answer: answerIdx
            });
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 15;
            const timerEl = document.getElementById('battle-timer');
            timerEl.textContent = timeLeft;
            timerEl.classList.remove('timer-danger');

            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;

                if (timeLeft <= 5) timerEl.classList.add('timer-danger');
                else timerEl.classList.remove('timer-danger');

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    // Auto-submit wrong answer (index -1)
                    if (!answeredCurrentQ) {
                        const q = currentQuestions[currentQuestionIdx];
                        submitAnswer(q.id, -1);
                    }
                }
            }, 1000);
        }
    </script>
</body>

</html>