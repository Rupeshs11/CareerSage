name: "0. Initial EC2 Setup"

on:
  workflow_dispatch:

jobs:
  setup:
    name: Setup EC2
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Install Docker and Nginx
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            sudo yum update -y
            sudo yum install docker nginx -y
            sudo systemctl start docker nginx
            sudo systemctl enable docker nginx
            sudo usermod -aG docker $USER
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            sudo yum install certbot python3-certbot-nginx -y
            mkdir -p ~/careersage
          EOF

      - name: Create docker-compose.yml
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cat > ~/careersage/docker-compose.yml << 'COMPOSE'
          services:
            mongodb:
              image: mongo:latest
              container_name: careersage-db
              ports:
                - "27017:27017"
              volumes:
                - mongo_data:/data/db
              environment:
                - MONGO_INITDB_DATABASE=careersage
              healthcheck:
                test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
                interval: 10s
                timeout: 5s
                retries: 5
                start_period: 10s
              restart: unless-stopped
              networks:
                - careersage-net

            app:
              image: rupeshs11/careersage:latest
              container_name: careersage-app
              ports:
                - "5000:5000"
              env_file:
                - .env
              environment:
                - FLASK_ENV=production
                - MONGODB_URI=mongodb://mongodb:27017/careersage
                - TZ=Asia/Kolkata
              depends_on:
                mongodb:
                  condition: service_healthy
              restart: unless-stopped
              networks:
                - careersage-net

          volumes:
            mongo_data:
              driver: local

          networks:
            careersage-net:
              driver: bridge
          COMPOSE
          EOF

      - name: Create Nginx Config
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            sudo tee /etc/nginx/conf.d/careersage.conf << 'NGINX'
          upstream flask_app {
              server 127.0.0.1:5000;
          }

          server {
              listen 80;
              server_name knoxcloud.tech www.knoxcloud.tech;

              location / {
                  proxy_pass http://flask_app;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_read_timeout 300s;
                  proxy_connect_timeout 75s;
                  proxy_send_timeout 300s;
              }

              location /socket.io/ {
                  proxy_pass http://flask_app/socket.io/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_read_timeout 86400s;
                  proxy_send_timeout 86400s;
              }
          }
          NGINX
            sudo mv /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.disabled 2>/dev/null || true
            sudo nginx -t && sudo systemctl reload nginx
          EOF

      - name: Start Containers
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/careersage
            sg docker -c "docker compose pull"
            sg docker -c "docker compose up -d"
          EOF
